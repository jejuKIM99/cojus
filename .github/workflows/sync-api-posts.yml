name: Sync API Posts and Publish cojus-cli

# 1ì‹œê°„ë§ˆë‹¤ í•œ ë²ˆì”© ì‹¤í–‰ (cron: UTC ê¸°ì¤€)
on:
  schedule:
    - cron: '0 15 * * *'      # ë§¤ ì‹œê°„ ì •ê° (UTC) â†’ í•œêµ­ ì‹œê° ê¸°ì¤€ ì‹œ+9
  workflow_dispatch:         # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  sync-and-publish:
    runs-on: ubuntu-latest

    steps:
      # 1) ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # ì´í›„ git pushë¥¼ ìœ„í•´ í•„ìš”

      # 2) Node.js ì„¤ì • ë° npm ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì¸ì¦
      - name: Setup Node.js and npm auth
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Configure npm auth token
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc

      # 3) Supabase í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
      - name: Load Supabase environment variables
        run: |
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> $GITHUB_ENV
          echo "SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}" >> $GITHUB_ENV

      # 4) ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 5) Supabaseì—ì„œ ë°ì´í„° ê°€ì ¸ì™€ JSON ì—…ë°ì´íŠ¸
      - name: Fetch API Posts to JSON
        run: npm run fetch-data

      # 6) ë³€ê²½ ê°ì§€ â†’ ë²„ì „ bump â†’ npm publish â†’ Git ì»¤ë°‹ & í‘¸ì‹œ
      - name: Check for changes, bump version, and publish to npm
        run: |
          # JSONë§Œ ë³€ê²½ëì„ ë•Œ(íŒ¨ì¹˜í•  í•­ëª©ì´ ìˆì„ ë•Œ)ë§Œ ì‹¤í–‰
          if [[ -n "$(git status --porcelain -- data/api_posts.json)" ]]; then
            echo "ğŸ”„ data/api_posts.json ë³€ê²½ ê°ì§€ë¨. ë²„ì „ bump ë° npm publish ì§„í–‰."

            # 6-1) íŒ¨ì¹˜ ë²„ì „ ìë™ ì¦ê°€ (package.jsonê³¼ package-lock.jsonë§Œ ë³€ê²½)
            npm version patch --no-git-tag-version

            # 6-2) npm ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— í¼ë¸”ë¦¬ì‹œ (í† í° ì¸ì¦ ì™„ë£Œëœ ìƒíƒœ)
            npm publish --access public

            # 6-3) Git ì‚¬ìš©ì ì •ë³´ ì„¤ì • (Actions bot)
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # 6-4) ë³€ê²½ëœ íŒŒì¼ë“¤ ìŠ¤í…Œì´ì§•
            git add data/api_posts.json package.json package-lock.json

            # 6-5) ì»¤ë°‹ (ë©”ì‹œì§€ì— [skip ci] ì¶”ê°€í•˜ì—¬ ë¬´í•œ ì¬ì‹¤í–‰ ë°©ì§€)
            git commit -m "chore: update api_posts.json & bump version [skip ci]"

            # 6-6) ë¸Œëœì¹˜ì— í‘¸ì‹œ
            git push origin HEAD:${{ github.ref_name }}
          else
            echo "âœ… data/api_posts.json ë³€ê²½ ì—†ìŒ. npm publish ìŠ¤í‚µ."
          fi
